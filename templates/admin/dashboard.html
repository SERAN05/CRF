{% extends "base.html" %}
{% block title %}Admin Dashboard | Course Feedback System{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
  .dashboard-card { margin-bottom: 20px; }
  .progress { height: 25px; }
</style>
{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="#">Course Feedback System</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link active" href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.manage_events') }}">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.manage_courses') }}">Courses</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.manage_students') }}">Students</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.results') }}">Results</a></li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.logout') }}">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Admin Dashboard</h1>
  <div class="row my-4">
    <div class="col-md-4">
      <div class="card dashboard-card">
        <div class="card-body">
          <h5>Active Event</h5>
          {% if active_event %}
            <p class="text-success">
              <a href="{{ url_for('admin.manage_events') }}" class="text-decoration-none">
                {{ active_event.title }}
              </a>
            </p>
          {% else %}
            <p class="text-danger">No active event</p>
          {% endif %}
          <a href="{{ url_for('admin.manage_events') }}" class="btn btn-primary">Manage Events</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card dashboard-card">
        <div class="card-body">
          <h5>Students</h5>
          <p>{{ total_students }} registered students</p>
          <a href="{{ url_for('admin.manage_students') }}" class="btn btn-primary">Manage Students</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card dashboard-card">
        <div class="card-body">
          <h5>Courses</h5>
          <p>{{ courses|length }} courses available</p>
          <a href="{{ url_for('admin.manage_courses') }}" class="btn btn-primary">Manage Courses</a>
        </div>
      </div>
    </div>
  </div>
  <div class="row my-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">
          Response Statistics
        </div>
        <div class="card-body">
          {% if active_event %}
            <div class="progress mb-3">
              <div class="progress-bar bg-success"
                   role="progressbar"
                   id="progressBar"
                   data-completion="{{ completion_rate }}"
                   aria-valuenow="{{ completion_rate }}"
                   aria-valuemin="0"
                   aria-valuemax="100">
                {{ completion_rate|round(1) }}%
              </div>
            </div>
            <p class="text-center">
              <strong>Completion Rate:</strong> {{ completion_rate|round(1) }}%<br>
              {{ event_responses }} responses out of {{ total_students }} students
            </p>
            <div class="text-center mb-2">
              <button id="showStudentResponses" class="btn btn-outline-primary btn-sm">Show Student Responses</button>
            </div>
            <!-- Modal for Student Responses -->
            <div class="modal fade" id="studentResponsesModal" tabindex="-1" aria-labelledby="studentResponsesModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="studentResponsesModalLabel">Student Response Status (Active Event)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3 text-end">
                      <label for="responseFilter" class="form-label me-2">Filter by Response:</label>
                      <select id="responseFilter" class="form-select d-inline-block w-auto">
                        <option value="none">None</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                      </select>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-bordered table-striped" id="studentResponsesTableModal">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Roll Number</th>
                            <th>Name</th>
                            <th>Response</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for student in students %}
                          <tr data-response="{% if student.id in responded_ids %}yes{% else %}no{% endif %}">
                            <td>{{ loop.index }}</td>
                            <td>{{ student.roll_number }}</td>
                            <td>{{ student.name }}</td>
                            <td>{% if student.id in responded_ids %}<span class="text-success fw-bold">Yes</span>{% else %}<span class="text-danger fw-bold">No</span>{% endif %}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    <div class="text-end mt-2">
                      <button id="downloadStudentResponsesPdf" class="btn btn-outline-primary btn-sm">Download PDF</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <a href="{{ url_for('admin.results') }}" class="btn btn-outline-primary w-100">View Detailed Results</a>
          {% else %}
            <div class="alert alert-warning">No active event to display statistics</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">
          Quick Actions
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{{ url_for('admin.manage_events') }}" class="btn btn-outline-primary">Create / Manage Event</a>
            <a href="{{ url_for('admin.manage_students') }}" class="btn btn-outline-primary">Upload Student List</a>
            <a href="{{ url_for('admin.manage_courses') }}" class="btn btn-outline-primary">Add New Course</a>
            <a href="{{ url_for('admin.results') }}" class="btn btn-outline-primary">Download Reports</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var progressBar = document.getElementById('progressBar');
  if (progressBar) {
    var completion = parseFloat(progressBar.getAttribute('data-completion')) || 0;
    progressBar.style.width = completion + '%';
  }
  var showBtn = document.getElementById('showStudentResponses');
  var modal = new bootstrap.Modal(document.getElementById('studentResponsesModal'));
  if(showBtn && modal){
    showBtn.addEventListener('click', function(){
      modal.show();
    });
  }
  // Filter logic
  var filter = document.getElementById('responseFilter');
  var table = document.getElementById('studentResponsesTableModal');
  if(filter && table){
    filter.addEventListener('change', function(){
      var value = this.value;
      var rows = table.querySelectorAll('tbody tr');
      rows.forEach(function(row){
        if(value === 'none'){
          row.style.display = '';
        } else {
          row.style.display = (row.getAttribute('data-response') === value) ? '' : 'none';
        }
      });
    });
  }
  var downloadBtn = document.getElementById('downloadStudentResponsesPdf');
  if(downloadBtn){
    downloadBtn.addEventListener('click', function(){
      window.location.href = '/admin/download_student_responses_pdf';
    });
  }
});
</script>
{% endblock %}
